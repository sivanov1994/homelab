{
  "$schema": "https://docs.renovatebot.com/renovate-schema.json",
  "extends": ["config:recommended"],
  "schedule": ["after 3am and before 4am on wednesday"],
  "enabledManagers": ["flux", "kubernetes"],
  "flux": {
    "fileMatch": [
      "(^|/)infrastructure/.+\\.ya?ml$",
      "(^|/)clusters/.+\\.ya?ml$"
    ]
  },
  "kubernetes": {
    "fileMatch": [
      "(^|/)infrastructure/.+\\.ya?ml$",
      "(^|/)clusters/.+\\.ya?ml$",
      "(^|/)apps/.+\\.ya?ml$",
      "(^|/)monitoring/.+\\.ya?ml$"
    ]
  },
  "customManagers": [
    {
      "customType": "regex",
      "fileMatch": ["(^|/)gotk-components\\.ya?ml$"],
      "matchStrings": [
        "# Flux Version: (?<currentValue>.*?)\\n"
      ],
      "datasourceTemplate": "github-releases",
      "depNameTemplate": "fluxcd/flux2",
      "versioningTemplate": "semver"
    }
  ],
  "packageRules": [
    {
      "matchDatasources": ["github-releases"],
      "matchPackageNames": ["fluxcd/flux2"],
      "postUpgradeTasks": {
        "commands": [
          "bash -c 'flux install --export --components source-controller,kustomize-controller,helm-controller,notification-controller > {{{packageFileDir}}}/gotk-components.yaml'"
        ],
        "fileFilters": ["clusters/staging/flux-system/gotk-components.yaml"],
        "executionMode": "branch"
      }
    }
  ]
}
